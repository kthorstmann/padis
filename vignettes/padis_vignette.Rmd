---
title: "PADIS vignette"
author: "Kai T. Horstmann"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This package was written for Lara Kammrath from Wake Forest University and her research. It contains some general functions that may apply to multiple, more general problems (section 1) and some very specific functions (section 2) that are tailored to Lara's specific tasks.

It relies on several different packages, which are installed automatically once this package is installed

- tidyr
- data.table
- stringr
- xlsx
- purrr
- psych


## How to install this package:

You can run the following code to install this package from GitHub:


```{r install paids, eval = FALSE, echo = TRUE}


install.packages("devtools")
devtools::install_github("kthorstmann/padis")
library(padis)


```


# Section 1 - General functions

### Example data frame

Th package contains a fake example data frame, `wide_example_data`, which is used to illustrate the functions.

```{r}

library(padis)
data <- wide_example_data
head(data)

```

## Data selection and transformation

### select_vars

This function can be used to select specific variables from a data set. It is primarily build on `grep` or `dplyr::select`.

```{r select_vars}

subset <- select_vars(data, id = "id", prefix="var_s")
head(subset, 3)

subset <- select_vars(data, id = c("id", "id2"), prefix="var_.+3$")
head(subset, 3)

```

To get more information on the use of regular expressions, see `?base::regex`.

### gather_one

```{r gather}

gather_df <- gather_one(data=data, key_vars="id", varying = c("var_p_1", "var_p_2"), new_name="var")
head(gather_df)

```

### swap_char

This function is used to change variable names since the `gather` function (see below, based on `tidyr::gather`) relies on a specific strucutre of item names. It is primarily used in some functions specific to the problem at hand (section 2).

```{r swap_char}

swap_char("this.string", ".", "_")

```


### gather_multiple

Similar to `gather_one`, `gather_multiple` turns several variables from a wide data frame into a long data frame. Several `key_vars` can be added, however, the new names of the resulting variables should be changed manually. The varying object should be set to NULL, and pererably all variables that should not be turned into th long format should be removed before applying this function.


```{r gather_multiple}

gather_mtpl_df <- gather_multiple(data=data, key_vars=c("id", "id2"), varying = NULL)
head(gather_mtpl_df)

```

### aggregate_df

```{r aggregate_df}

library(padis)
df <- aggregate_df(wide_example_data, id="id")
head(df)

```


## Saving data

```{r write_to_wd, message=FALSE, error=FALSE, eval = FALSE, echo = TRUE}

# If the function is called for the first time and the file does not exist
write_to_wd(data, folder = NULL, type = "xlsx", name="example_data_wfu", overwrite=FALSE)


```


# Section 2 - specific padis functions

Section 2 contains the functions that are specifically built for the tasks at Wake Forest Unviersity and Lara Kammrath's workgroup. They may not be applicable to a broader set of problems. However, they all rely on the functions above.

```{r, eval = FALSE}


data_dy <- xlsx::read.xlsx("/Users/kaihorstmann/Dropbox/01Uni/01Projekte/96collaboration/Lara Kammrath/Materials/data/Raw Diary Sample.xlsx", 1)
data_in <- xlsx::read.xlsx("/Users/kaihorstmann/Dropbox/01Uni/01Projekte/96collaboration/Lara Kammrath/Materials/data/Raw Intake Sample.xlsx", 1)

## transform data sets

# 1) In intake raw data, leave all variables that start with PAR.variable in the new participant-level dataset. Make sure PAR.ID is there as the ID variable.

## 1. participant data set:
par_data <- select_vars(data_in, ids = c("PAR.ID"), prefix = "^PAR")
head(par_data)

# 2) In intake raw data, move all variables that start with PSP.variable into the new PSP-level dataset. These should be stacked so that there is only one PSP per line (typically 1-16 per participant). Make sure that PAR.ID, PSP.ID, and PSP.Unique ID are included as the ID variables. (PSP.ID is ordinal within participant, PSP.UniqueID is unique across the dataset).

## 2. PSP level data set:
psp_data <- select_vars(data_in, ids = c("PAR.ID"), prefix = "^PSP")
psp_long <- gather_multiple(psp_data, key_vars=c("PAR.ID"), search="PSP\\d+\\.")

# 3) In daily diary raw data, leave all variables that start with DAY.variable in the new Day-leveld dataset. These should be stacked so that there is only one day per line (typically 2-14 per participant). ID variables should include PAR.ID, Day.Num, Day.UniqueID, Day.DaysIn. (Day.Num is ordinal within participant, Day.UniqueID is unique across the dataset, and Days.DaysIn is the linear num days since they started the study).

## 3. DAY level (they are already correctly aggregated)
day_data <- select_vars(data_dy, ids = c("PAR.ID"), prefix = "^Day")
## this is already stacked correctly

# 4) In the daily diary raw data, move all variables that start with Issue.variable in the new Issue-level dataset. They should be stacked with one issue per line (typically 1-2 issues per participant). ID variables should include PAR.ID, Day.Num, Day.UniqueID, Day.DaysIn, Issue.Num, Issue.UniqueID.

## 4. Issue level
issue_data <- select_vars(data_dy, ids = c("PAR.ID", "Day.Num", "Day.UniqueID", "Day.DaysIn"), prefix = "Issue")
issue_data <- dplyr::select(issue_data, -Issue2.Support.Emo) ## remove Issue.Emo here, because it is not correct currently
issue_long <- gather_multiple(issue_data, key_vars=c("PAR.ID", "Day.Num", "Day.UniqueID", "Day.DaysIn"), search="Issue\\d+.")
# this is correct, but need to change the names here possibly

# 5) In the daily diary raw data, move all variables that start with Sought.variable in the new Selection-level dataset. They should be stacked with one selection decision (0/1) per line (typically 15-16 decisions per participant per issue). ID variables should include PAR.ID, Day.Num, Day.UniqueID, Day.DaysIn, Issue.Num, Issue.UniqueID, PSP.num, and PSP.UniqueID. 

## 5. sought level data

## here is an error, the problem is that I am not sure how this data frame should look like

sought_data <- select_vars(data_dy, ids = c("PAR.ID", "Day.Num", "Day.UniqueID", "Day.DaysIn", "Issue.Num", "Issue.UniqueID"),
                           prefix = "Sought\\.")

sought_long <- gather_multiple(sought_data, key_vars=c("PAR.ID", "Day.Num", "Day.UniqueID"), search = "PSP\\d+\\.")

## make list with data frames
names_df_long <- c("PAR_data", "PSP_data", "DAY_data", "ISSUE_data", "SOUGHT_data")
long_df_list <- list(par_data, psp_long, day_data, issue_long, sought_long)

# write_to <- "workspace"
if (write_to == "workspace") {
  # this does not work with map, because of the deparse stuff. have to do this with paste
  purrr::map(long_df_list, ~ write_to_ws(., overwrite = FALSE))
}

if (write_to == "xlsx" || write_to == "csv") {
  # this does not work with map, because of the deparse stuff. have to do this with paste
  write_to_wd()
}




```














